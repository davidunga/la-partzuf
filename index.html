<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />
        <title>La' Partzuf</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Inter:wght@300;400;500;600&display=swap"
            rel="stylesheet"
        />
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"
        ></script>
        <style>
            :root {
                --bg-primary: #0d0d0d;
                --bg-secondary: #1a1a1a;
                --bg-elevated: #242424;

                --surface: #1f1f1f;
                --surface-hover: #252525;

                --primary: #ffffff;
                --secondary: #a1a1a1;
                --tertiary: #6b6b6b;

                --reference-1: #ff6b6b;
                --reference-2: #4ecdc4;
                --subject: #ffd93d;

                --border: rgba(255, 255, 255, 0.08);
                --border-hover: rgba(255, 255, 255, 0.15);

                --shadow-sm: 0 2px 12px rgba(0, 0, 0, 0.4);
                --shadow-md: 0 4px 24px rgba(0, 0, 0, 0.5);
                --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.6);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                -webkit-tap-highlight-color: transparent;
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    sans-serif;
                background: var(--bg-primary);
                color: var(--primary);
                min-height: 100vh;
                padding: 1.5rem;
                line-height: 1.6;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            @media (min-width: 768px) {
                body {
                    padding: 3rem 2rem;
                }
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            header {
                text-align: center;
                margin-bottom: 2.5rem;
                animation: fadeInDown 0.6s ease-out;
            }

            @media (min-width: 768px) {
                header {
                    margin-bottom: 4rem;
                }
            }

            h1 {
                font-family: "Cormorant Garamond", serif;
                font-size: 2.5rem;
                font-weight: 300;
                color: var(--primary);
                margin-bottom: 0.5rem;
                letter-spacing: 0.02em;
            }

            @media (min-width: 768px) {
                h1 {
                    font-size: 3.5rem;
                }
            }

            .subtitle {
                font-size: 0.95rem;
                color: var(--secondary);
                font-weight: 300;
                letter-spacing: 0.03em;
            }

            @media (min-width: 768px) {
                .subtitle {
                    font-size: 1.05rem;
                }
            }

            .status-banner {
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 1rem;
                margin-bottom: 2rem;
                text-align: center;
                font-size: 0.9rem;
                color: var(--secondary);
                animation: fadeInUp 0.6s ease-out 0.1s both;
            }

            @media (min-width: 768px) {
                .status-banner {
                    padding: 1.25rem;
                    margin-bottom: 3rem;
                }
            }

            .status-banner.loading {
                border-color: rgba(255, 217, 61, 0.3);
                color: var(--subject);
            }

            .status-banner.error {
                border-color: rgba(255, 107, 107, 0.3);
                color: var(--reference-1);
                background: rgba(255, 107, 107, 0.05);
            }

            .upload-section {
                display: grid;
                grid-template-columns: 1fr;
                gap: 1.5rem;
                margin-bottom: 2rem;
                animation: fadeInUp 0.6s ease-out 0.2s both;
            }

            @media (min-width: 768px) {
                .upload-section {
                    grid-template-columns: repeat(3, 1fr);
                    gap: 2rem;
                    margin-bottom: 3rem;
                }
            }

            .person-card {
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 16px;
                overflow: hidden;
                transition: all 0.3s ease;
            }

            .person-card:active {
                transform: scale(0.98);
            }

            @media (min-width: 768px) {
                .person-card:hover {
                    border-color: var(--border-hover);
                    transform: translateY(-4px);
                    box-shadow: var(--shadow-md);
                }

                .person-card:active {
                    transform: scale(1);
                }
            }

            .card-label {
                padding: 1.25rem 1.5rem;
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: rgba(255, 255, 255, 0.02);
            }

            .label-content {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .person-number {
                font-family: "Cormorant Garamond", serif;
                font-size: 1.5rem;
                font-weight: 400;
                color: var(--primary);
                width: 38px;
                height: 38px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                background: var(--bg-elevated);
                border: 1px solid var(--border);
            }

            .label-text {
                font-size: 0.8rem;
                font-weight: 500;
                letter-spacing: 0.08em;
                text-transform: uppercase;
                padding: 0.4rem 0.9rem;
                border-radius: 20px;
                background: rgba(255, 255, 255, 0.05);
                color: var(--secondary);
            }

            .person-card.person-1 .label-text {
                background: rgba(255, 107, 107, 0.1);
                color: var(--reference-1);
            }

            .person-card.person-2 .label-text {
                background: rgba(78, 205, 196, 0.1);
                color: var(--reference-2);
            }

            .person-card.person-3 .label-text {
                background: rgba(255, 217, 61, 0.1);
                color: var(--subject);
            }

            .card-body {
                padding: 1.5rem;
            }

            .name-input {
                width: 100%;
                background: var(--bg-elevated);
                border: 1px solid var(--border);
                border-radius: 10px;
                padding: 0.875rem 1rem;
                color: var(--primary);
                font-size: 1rem;
                font-weight: 400;
                outline: none;
                transition: all 0.3s ease;
                margin-bottom: 1.25rem;
                font-family: "Inter", sans-serif;
            }

            .name-input:focus {
                background: var(--surface-hover);
                border-color: var(--border-hover);
                box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
            }

            .name-input::placeholder {
                color: rgb(255, 0, 80);
            }

            .upload-zone {
                border: 2px dashed var(--border);
                border-radius: 12px;
                padding: 2.5rem 1.5rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s ease;
                background: rgba(255, 255, 255, 0.02);
                min-height: 160px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .upload-zone:active {
                transform: scale(0.98);
            }

            @media (min-width: 768px) {
                .upload-zone:hover {
                    border-color: var(--border-hover);
                    background: rgba(255, 255, 255, 0.04);
                }
            }

            .upload-zone.dragover {
                border-color: var(--primary);
                background: rgba(255, 255, 255, 0.06);
                border-style: solid;
            }

            .upload-icon {
                width: 48px;
                height: 48px;
                margin-bottom: 1rem;
                opacity: 0.4;
            }

            .upload-text {
                color: var(--secondary);
                font-size: 0.95rem;
                line-height: 1.5;
                font-weight: 400;
            }

            .upload-text small {
                display: block;
                font-size: 0.8rem;
                color: var(--tertiary);
                margin-top: 0.4rem;
                font-weight: 300;
            }

            .image-preview {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
                gap: 0.75rem;
                margin-top: 1.25rem;
            }

            @media (min-width: 768px) {
                .image-preview {
                    grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
                }
            }

            .preview-img {
                width: 100%;
                height: 75px;
                object-fit: cover;
                border-radius: 8px;
                border: 1px solid var(--border);
                animation: scaleIn 0.3s ease-out;
                transition: all 0.2s ease;
            }

            @media (min-width: 768px) {
                .preview-img {
                    height: 85px;
                }

                .preview-img:hover {
                    transform: scale(1.05);
                    border-color: var(--border-hover);
                }
            }

            .analyze-btn {
                display: block;
                width: 100%;
                margin: 0 auto 2rem;
                background: var(--primary);
                color: var(--bg-primary);
                border: none;
                padding: 1rem;
                font-size: 1rem;
                font-weight: 500;
                border-radius: 12px;
                cursor: pointer;
                font-family: "Inter", sans-serif;
                letter-spacing: 0.02em;
                transition: all 0.3s ease;
                animation: fadeInUp 0.6s ease-out 0.4s both;
                touch-action: manipulation;
            }

            @media (min-width: 768px) {
                .analyze-btn {
                    width: auto;
                    padding: 1rem 3rem;
                    margin-bottom: 3rem;
                }
            }

            .analyze-btn:active:not(:disabled) {
                transform: scale(0.96);
            }

            @media (min-width: 768px) {
                .analyze-btn:hover:not(:disabled) {
                    background: var(--secondary);
                    transform: translateY(-2px);
                    box-shadow: var(--shadow-md);
                }
            }

            .analyze-btn:disabled {
                opacity: 0.3;
                cursor: not-allowed;
            }

            .spectrum-container {
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 2rem 1.5rem;
                animation: fadeInUp 0.6s ease-out 0.6s both;
                min-height: 400px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            @media (min-width: 768px) {
                .spectrum-container {
                    padding: 3rem;
                    min-height: 450px;
                }
            }

            .spectrum-title {
                font-family: "Cormorant Garamond", serif;
                font-size: 1.75rem;
                font-weight: 400;
                text-align: center;
                margin-bottom: 2.5rem;
                color: var(--primary);
            }

            @media (min-width: 768px) {
                .spectrum-title {
                    font-size: 2rem;
                    margin-bottom: 3rem;
                }
            }

            .spectrum-scale {
                position: relative;
                height: 220px;
                margin: 0 1rem;
            }

            @media (min-width: 768px) {
                .spectrum-scale {
                    margin: 0 4rem;
                }
            }

            .scale-line {
                position: absolute;
                top: 50%;
                left: 0;
                right: 0;
                height: 1px;
                background: linear-gradient(
                    90deg,
                    var(--reference-2),
                    transparent 30%,
                    transparent 70%,
                    var(--reference-1)
                );
                opacity: 0.3;
            }

            .scale-endpoint {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.75rem;
            }

            .scale-endpoint.left {
                left: -0.5rem;
            }

            .scale-endpoint.right {
                right: -0.5rem;
            }

            @media (min-width: 768px) {
                .scale-endpoint.left {
                    left: -3rem;
                }

                .scale-endpoint.right {
                    right: -3rem;
                }
            }

            .endpoint-avatar {
                width: 70px;
                height: 70px;
                border-radius: 50%;
                border: 2px solid var(--reference-2);
                object-fit: cover;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            }

            @media (min-width: 768px) {
                .endpoint-avatar {
                    width: 90px;
                    height: 90px;
                    border-width: 3px;
                }

                .endpoint-avatar:hover {
                    transform: scale(1.05);
                }
            }

            .scale-endpoint.right .endpoint-avatar {
                border-color: var(--reference-1);
            }

            .endpoint-name {
                font-weight: 500;
                font-size: 0.85rem;
                color: var(--primary);
                text-align: center;
            }

            @media (min-width: 768px) {
                .endpoint-name {
                    font-size: 0.9rem;
                }
            }

            .endpoint-label {
                font-size: 0.7rem;
                color: var(--tertiary);
                text-transform: uppercase;
                letter-spacing: 0.05em;
                font-weight: 500;
            }

            .person-marker {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.75rem;
                transition: all 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
                opacity: 0;
            }

            .person-marker.show {
                opacity: 1;
            }

            .marker-avatar {
                width: 90px;
                height: 90px;
                border-radius: 50%;
                border: 3px solid var(--subject);
                object-fit: cover;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
                animation: float 3s ease-in-out infinite;
            }

            @media (min-width: 768px) {
                .marker-avatar {
                    width: 110px;
                    height: 110px;
                    border-width: 4px;
                }
            }

            .marker-name {
                font-weight: 600;
                font-size: 0.95rem;
                color: var(--primary);
                text-align: center;
            }

            @media (min-width: 768px) {
                .marker-name {
                    font-size: 1rem;
                }
            }

            .marker-label {
                font-size: 0.7rem;
                color: var(--tertiary);
                text-transform: uppercase;
                letter-spacing: 0.05em;
                font-weight: 500;
            }

            .similarity-info {
                text-align: center;
                margin-top: 2rem;
                padding: 1.5rem;
                background: rgba(255, 255, 255, 0.03);
                border-radius: 12px;
                font-size: 0.9rem;
                color: var(--secondary);
                line-height: 1.9;
                border: 1px solid var(--border);
            }

            @media (min-width: 768px) {
                .similarity-info {
                    margin-top: 2.5rem;
                    padding: 1.75rem;
                    font-size: 0.95rem;
                }
            }

            .similarity-value {
                color: var(--primary);
                font-weight: 600;
            }

            .loading {
                text-align: center;
                padding: 2rem;
                color: var(--secondary);
                font-style: italic;
                font-weight: 300;
            }

            @media (min-width: 768px) {
                .loading {
                    padding: 3rem;
                }
            }

            .loading::after {
                content: "...";
                animation: dots 1.5s steps(4, end) infinite;
            }

            .error-message {
                background: rgba(255, 107, 107, 0.08);
                border: 1px solid rgba(255, 107, 107, 0.2);
                border-radius: 12px;
                padding: 1.5rem;
                margin: 2rem 0;
                color: var(--reference-1);
                text-align: center;
                font-weight: 400;
            }

            @keyframes dots {
                0%,
                20% {
                    content: ".";
                }
                40% {
                    content: "..";
                }
                60%,
                100% {
                    content: "...";
                }
            }

            @keyframes fadeInDown {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes scaleIn {
                from {
                    opacity: 0;
                    transform: scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            @keyframes float {
                0%,
                100% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-8px);
                }
            }

            /* iOS specific improvements */
            @supports (-webkit-touch-callout: none) {
                body {
                    min-height: -webkit-fill-available;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>La' Partzuf - Face Similarity</h1>
                <p class="subtitle">Neural embedding analysis</p>
            </header>

            <div class="upload-section">
                <div class="person-card person-1" data-person="1">
                    <div class="card-label">
                        <div class="label-content">
                            <div class="person-number">1</div>
                        </div>
                        <div class="label-text">Reference • Right</div>
                    </div>
                    <div class="card-body">
                        <input
                            type="text"
                            class="name-input"
                            placeholder="Enter name"
                            data-name-for="1"
                        />
                        <div class="upload-zone" data-upload-for="1">
                            <svg
                                class="upload-icon"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="1.5"
                            >
                                <rect
                                    x="3"
                                    y="3"
                                    width="18"
                                    height="18"
                                    rx="2"
                                    ry="2"
                                ></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <div class="upload-text">
                                Upload images
                                <small>Tap to select photos</small>
                            </div>
                            <input
                                type="file"
                                multiple
                                accept="image/*"
                                style="display: none"
                                data-input-for="1"
                            />
                        </div>
                        <div class="image-preview" data-preview-for="1"></div>
                    </div>
                </div>

                <div class="person-card person-2" data-person="2">
                    <div class="card-label">
                        <div class="label-content">
                            <div class="person-number">2</div>
                        </div>
                        <div class="label-text">Reference • Left</div>
                    </div>
                    <div class="card-body">
                        <input
                            type="text"
                            class="name-input"
                            placeholder="Enter name"
                            data-name-for="2"
                        />
                        <div class="upload-zone" data-upload-for="2">
                            <svg
                                class="upload-icon"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="1.5"
                            >
                                <rect
                                    x="3"
                                    y="3"
                                    width="18"
                                    height="18"
                                    rx="2"
                                    ry="2"
                                ></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <div class="upload-text">
                                Upload images
                                <small>Tap to select photos</small>
                            </div>
                            <input
                                type="file"
                                multiple
                                accept="image/*"
                                style="display: none"
                                data-input-for="2"
                            />
                        </div>
                        <div class="image-preview" data-preview-for="2"></div>
                    </div>
                </div>

                <div class="person-card person-3" data-person="3">
                    <div class="card-label">
                        <div class="label-content">
                            <div class="person-number">3</div>
                        </div>
                        <div class="label-text">Subject</div>
                    </div>
                    <div class="card-body">
                        <input
                            type="text"
                            class="name-input"
                            placeholder="Enter name"
                            data-name-for="3"
                        />
                        <div class="upload-zone" data-upload-for="3">
                            <svg
                                class="upload-icon"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="1.5"
                            >
                                <rect
                                    x="3"
                                    y="3"
                                    width="18"
                                    height="18"
                                    rx="2"
                                    ry="2"
                                ></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <div class="upload-text">
                                Upload images
                                <small>Tap to select photos</small>
                            </div>
                            <input
                                type="file"
                                multiple
                                accept="image/*"
                                style="display: none"
                                data-input-for="3"
                            />
                        </div>
                        <div class="image-preview" data-preview-for="3"></div>
                    </div>
                </div>
            </div>

            <button class="analyze-btn" id="analyzeBtn" disabled>
                Analyze Similarity
            </button>

            <div class="spectrum-container" id="spectrumContainer">
                <div class="spectrum-title">Similarity Spectrum</div>
                <div id="spectrumContent">
                    <p
                        style="
                            text-align: center;
                            color: var(--secondary);
                            font-style: italic;
                            font-weight: 300;
                        "
                    >
                        Upload images for all three people to begin analysis
                    </p>
                </div>
            </div>
        </div>

        <script>
            // Store uploaded images for each person
            const personData = {
                1: { images: [], name: "", embeddings: [] },
                2: { images: [], name: "", embeddings: [] },
                3: { images: [], name: "", embeddings: [] },
            };

            let modelsLoaded = false;

            // Load face-api.js models
            async function loadModels() {
                const statusBanner = document.getElementById("statusBanner");
                try {
                    statusBanner.classList.add("loading");
                    statusBanner.textContent = "Loading AI models...";

                    const MODEL_URL =
                        "https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/";

                    await Promise.all([
                        faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    ]);

                    modelsLoaded = true;
                    statusBanner.classList.remove("loading");
                    statusBanner.textContent = "Ready to analyze faces";

                    setTimeout(() => {
                        statusBanner.style.display = "none";
                    }, 3000);
                } catch (error) {
                    console.error("Error loading models:", error);
                    statusBanner.classList.add("error");
                    statusBanner.textContent =
                        "Error loading AI models. Please refresh the page.";
                }
            }

            // Load models on page load
            window.addEventListener("load", loadModels);

            // Initialize upload zones
            document.querySelectorAll(".upload-zone").forEach((zone) => {
                const personId = zone.dataset.uploadFor;
                const input = document.querySelector(
                    `input[data-input-for="${personId}"]`,
                );

                zone.addEventListener("click", () => input.click());

                zone.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    zone.classList.add("dragover");
                });

                zone.addEventListener("dragleave", () => {
                    zone.classList.remove("dragover");
                });

                zone.addEventListener("drop", (e) => {
                    e.preventDefault();
                    zone.classList.remove("dragover");
                    handleFiles(personId, e.dataTransfer.files);
                });

                input.addEventListener("change", (e) => {
                    handleFiles(personId, e.target.files);
                });
            });

            // Initialize name inputs
            document.querySelectorAll(".name-input").forEach((input) => {
                const personId = input.dataset.nameFor;
                input.addEventListener("input", (e) => {
                    personData[personId].name = e.target.value;
                    updateAnalyzeButton();
                });
            });

            function handleFiles(personId, files) {
                const preview = document.querySelector(
                    `[data-preview-for="${personId}"]`,
                );

                Array.from(files).forEach((file) => {
                    if (file.type.startsWith("image/")) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            personData[personId].images.push({
                                data: e.target.result,
                                file: file,
                            });

                            const img = document.createElement("img");
                            img.src = e.target.result;
                            img.className = "preview-img";
                            preview.appendChild(img);

                            updateAnalyzeButton();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            function updateAnalyzeButton() {
                const allHaveImages =
                    personData[1].images.length > 0 &&
                    personData[2].images.length > 0 &&
                    personData[3].images.length > 0;
                const allHaveNames =
                    personData[1].name &&
                    personData[2].name &&
                    personData[3].name;

                document.getElementById("analyzeBtn").disabled = !(
                    allHaveImages &&
                    allHaveNames &&
                    modelsLoaded
                );
            }

            async function getFaceEmbedding(imageDataUrl) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = async () => {
                        try {
                            const detection = await faceapi
                                .detectSingleFace(img)
                                .withFaceLandmarks()
                                .withFaceDescriptor();

                            if (!detection) {
                                reject(new Error("No face detected in image"));
                                return;
                            }

                            resolve(detection.descriptor);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    img.onerror = () =>
                        reject(new Error("Failed to load image"));
                    img.src = imageDataUrl;
                });
            }

            function euclideanDistance(embedding1, embedding2) {
                let sum = 0;
                for (let i = 0; i < embedding1.length; i++) {
                    sum += Math.pow(embedding1[i] - embedding2[i], 2);
                }
                return Math.sqrt(sum);
            }

            function cosineDistance(embedding1, embedding2) {
                let dotProduct = 0;
                let norm1 = 0;
                let norm2 = 0;
                
                for (let i = 0; i < embedding1.length; i++) {
                    dotProduct += embedding1[i] * embedding2[i];
                    norm1 += embedding1[i] * embedding1[i];
                    norm2 += embedding2[i] * embedding2[i];
                }
                
                const cosSim = dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2));
                return 1 - cosSim;
            }
            
            function averageEmbeddings(embeddings) {
                const dim = embeddings[0].length;
                const avg = new Array(dim).fill(0);

                for (const emb of embeddings) {
                    for (let i = 0; i < dim; i++) {
                        avg[i] += emb[i];
                    }
                }

                for (let i = 0; i < dim; i++) {
                    avg[i] /= embeddings.length;
                }

                return avg;
            }

            function calculatePosition(d1_2, d1_3, d2_3) {
                const total = d1_3 + d2_3;
                if (total === 0) return 0.5;
                return Math.max(0, Math.min(1, d2_3 / total));
            }

            document
                .getElementById("analyzeBtn")
                .addEventListener("click", analyzeSimilarity);

            async function analyzeSimilarity() {
                const spectrumContent =
                    document.getElementById("spectrumContent");
                spectrumContent.innerHTML =
                    '<p class="loading">Analyzing facial features</p>';

                try {
                    // Get embeddings for all persons
                    for (const personId of ["1", "2", "3"]) {
                        personData[personId].embeddings = [];

                        for (const img of personData[personId].images) {
                            try {
                                const embedding = await getFaceEmbedding(
                                    img.data,
                                );
                                personData[personId].embeddings.push(
                                    Array.from(embedding),
                                );
                            } catch (error) {
                                console.warn(
                                    `Skipping image for person ${personId}:`,
                                    error.message,
                                );
                            }
                        }

                        if (personData[personId].embeddings.length === 0) {
                            throw new Error(
                                `No faces detected for ${personData[personId].name}. Please use clearer face photos.`,
                            );
                        }
                    }

                    // Average embeddings
                    const embedding1 = averageEmbeddings(
                        personData["1"].embeddings,
                    );
                    const embedding2 = averageEmbeddings(
                        personData["2"].embeddings,
                    );
                    const embedding3 = averageEmbeddings(
                        personData["3"].embeddings,
                    );

                    // Calculate distances
                    const distance_1_2 = cosineDistance(
                        embedding1,
                        embedding2,
                    );
                    const distance_1_3 = cosineDistance(
                        embedding1,
                        embedding3,
                    );
                    const distance_2_3 = cosineDistance(
                        embedding2,
                        embedding3,
                    );

                    // Calculate position
                    const position = calculatePosition(
                        distance_1_2,
                        distance_1_3,
                        distance_2_3,
                    );

                    displayResults({
                        distance_1_2,
                        distance_1_3,
                        distance_2_3,
                        position,
                    });
                } catch (error) {
                    console.error("Error:", error);
                    spectrumContent.innerHTML = `
                    <div class="error-message">
                        ${error.message}
                    </div>
                `;
                }
            }

            function displayResults(result) {
                const { distance_1_2, distance_1_3, distance_2_3, position } =
                    result;
                const positionPercent = position * 100;

                const person1Img = personData["1"].images[0].data;
                const person2Img = personData["2"].images[0].data;
                const person3Img = personData["3"].images[0].data;

                const html = `
                <div class="spectrum-scale">
                    <div class="scale-line"></div>

                    <div class="scale-endpoint left">
                        <img src="${person2Img}" alt="${personData["2"].name}" class="endpoint-avatar">
                        <div class="endpoint-name">${personData["2"].name}</div>
                    </div>

                    <div class="scale-endpoint right">
                        <img src="${person1Img}" alt="${personData["1"].name}" class="endpoint-avatar">
                        <div class="endpoint-name">${personData["1"].name}</div>
                    </div>

                    <div class="person-marker show" style="left: ${positionPercent}%">
                        <img src="${person3Img}" alt="${personData["3"].name}" class="marker-avatar">
                        <div class="marker-name">${personData["3"].name}</div>
                    </div>
                </div>

                <div class="similarity-info">
                    <strong>${personData["3"].name}</strong> positioned at <span class="similarity-value">${(position * 100).toFixed(1)}%</span> along the spectrum<br>
                    Distance to <span class="similarity-value">${personData["1"].name}: ${distance_1_3.toFixed(3)}</span> •
                    Distance to <span class="similarity-value">${personData["2"].name}: ${distance_2_3.toFixed(3)}</span><br>
                    Reference separation: <span class="similarity-value">${distance_1_2.toFixed(3)}</span>
                </div>
            `;

                document.getElementById("spectrumContent").innerHTML = html;
            }
        </script>
    </body>
</html>
